package pers.qiqcheng.ec.listener;

import java.util.List;

import javax.servlet.http.HttpSession;
import javax.servlet.http.HttpSessionEvent;
import javax.servlet.http.HttpSessionListener;

import pers.qiqcheng.ec.bean.CartBean;
import pers.qiqcheng.ec.bean.CartItemBean;
import pers.qiqcheng.ec.factory.DaoFactory;

public class SessionListener implements HttpSessionListener {
	@Override
	public void sessionDestroyed(HttpSessionEvent se) {
		System.out.println("session destroy");
		HttpSession session=se.getSession();
		String username=(String) session.getAttribute("username");
		if(username!=null){
			CartBean cartBean=(CartBean) session.getAttribute("cartBean");
			if(cartBean!=null){
				String sql="insert into t_cart values(?,?,?)";
				List<CartItemBean> list=cartBean.getItems();
				for (CartItemBean cartItemBean : list) {
					String params[]={username,cartItemBean.getGoodID(),cartItemBean.getCount()+""};
					try {
						DaoFactory.getUserDaoInstances().doInsert(sql, params);
					} catch (Exception e) {
						e.printStackTrace();
					}
				}	
			}
		}
	}
}

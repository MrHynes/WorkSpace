package pers.qiqcheng.ec.servlet.admin;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.URLDecoder;
import java.sql.ResultSet;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.FileUploadException;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;

import net.sf.json.JSONArray;
import pers.qiqcheng.ec.bean.GoodsBean;
import pers.qiqcheng.ec.factory.DaoFactory;
import pers.qiqcheng.ec.tools.MultipartRequestWrapper;

public class AdminGoodInfoServlet extends HttpServlet{

	public void getGoods(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		String sql="select goodid,goodname,goodprice,inventory from t_goods "
				+ "where goodname like ? and goodprice>=? and goodprice<=?";
		String params[]={"%",0+"",Double.MAX_VALUE+""};
		String bookName=req.getParameter("k_bookname");
		String l_price=req.getParameter("kl_price");
		String r_price=req.getParameter("kr_price");
		if(bookName!=null&&bookName.length()>0){
			params[0]="%"+bookName+"%";
		}
		if(l_price!=null&&l_price.length()>0){
			params[1]=l_price;
		}
		if(r_price!=null&&r_price.length()>0){
			params[2]=r_price;
		}
		/*for (String string : params) {
			System.out.println(string);
		}*/
		ArrayList<GoodsBean> items=new ArrayList<GoodsBean>();
		GoodsBean goodsBean=null;
		HttpSession session=req.getSession();
		try {
			ResultSet rs=DaoFactory.getUserDaoInstances().doSelect(sql, params);
			while(rs.next()){
				goodsBean=new GoodsBean();
				goodsBean.setGoodId(rs.getString(1));
				goodsBean.setGoodName(rs.getString(2));
				goodsBean.setGoodPrice(rs.getFloat(3));
				goodsBean.setInventory(rs.getInt(4));
				items.add(goodsBean);
			}
			session.setAttribute("adm_goods", items);
			req.getRequestDispatcher("/backend/adminGoodInfo.jsp").forward(req, resp);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	public void upLoadImg(HttpServletRequest req, HttpServletResponse resp,String goodImgID) throws ServletException, IOException {
		String filePath=this.getServletContext().getRealPath("/simg");
		File file=new File(filePath);
		//如果目录不存在，就新建一个。
		if(!file.exists()&&!file.isDirectory()){
			//创建目录
			file.mkdir();
		}
		//使用Apache文件上传组件处理文件上传步骤：
		//1、创建一个DiskFileItemFactory工厂
		DiskFileItemFactory factory=new DiskFileItemFactory();
		//2、创建一个文件上传解析器
		ServletFileUpload upload=new ServletFileUpload(factory);
		//解决上传文件名的中文乱码
		upload.setHeaderEncoding("utf-8");
		//3、判断提交上来的数据是否是上传表单的数据
		if(!ServletFileUpload.isMultipartContent(req)){
			return;
		}
		//4、使用ServletFileUpload解析器解析上传数据，解析结果返回的是一个List<FileItem>集合，每一个FileItem对应一个Form表单的输入项
		List<FileItem> list;
		try {
			list = upload.parseRequest(req);
			for (FileItem item : list) {
				//如果fileitem中封装的是普通输入项的数据
				if(item.isFormField()){
					String name=item.getFieldName();
					//解决普通输入项的数据的中文乱码问题
					String value=item.getString("UTF-8");
				}else{//如果fileitem中封装的是上传文件
					String filename = item.getName();//得到上传的文件名称，
					if(filename==null || filename.trim().equals("")){
						continue;
					}
					//处理获取到的上传文件的文件名的路径部分，只保留文件名部分
					filename = filename.substring(filename.lastIndexOf("\\")+1);
					InputStream in = item.getInputStream();//获取item中的上传文件的输入流
					//创建一个文件输出流
					FileOutputStream out = new FileOutputStream(filePath + "\\" + goodImgID+".jpg");
					byte buffer[] = new byte[1024];//创建一个缓冲区
					//判断输入流中的数据是否已经读完的标识
					int len = 0;
					while((len=in.read(buffer))>0){
						//使用FileOutputStream输出流将缓冲区的数据写入到指定的目录(savePath + "\\" + filename)当中
						out.write(buffer, 0, len);
					}
					in.close();
					out.close();
					//删除处理文件上传时生成的临时文件
					item.delete();
				}
			}
		} catch (FileUploadException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}
	/**
	 * 添加商品信息，包括文件上传。
	 * 文件上传 需修改form表单的 enctype="multipart/form-data"
	 * 如此，就无法像往常一样通过req.getParameter("XX");获得值
	 * 解决方法：类MultipartRequestWrapper，对reques重新包装
	 * http://www.2cto.com/kf/201603/492916.html
	 */
	public void addGood(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		//id ,time,goodimage
		req = new MultipartRequestWrapper(req);//重新包装
		String goodname=req.getParameter("goodname");
		String type=req.getParameter("type");//父类别
		String suptype=req.getParameter("suptype");//子类别
		String price=req.getParameter("price");
		String inventory=req.getParameter("inventory");
		String introduction=req.getParameter("introduction");
		Date date=new Date();
		SimpleDateFormat sdf=new SimpleDateFormat("yyyyMMddHHmmss");
		SimpleDateFormat sdf2=new SimpleDateFormat("yyyy-MM-dd");
		String goodID=sdf.format(date);
		String addTime=sdf2.format(date);
		upLoadImg(req, resp, goodID);
		String sql="insert into t_goods values(?,?,?,?,?,?,?,?,?)";
		String params[]={goodID,type,suptype,goodname,price,introduction,goodID,addTime,inventory};
		/*for (String string : params) {
			System.out.print(string+" ");
		}*/
		boolean flag=false;
		try {
			flag=DaoFactory.getUserDaoInstances().doInsert(sql, params);
		} catch (Exception e) {
			e.printStackTrace();
		}
		/*if(flag){
			req.getRequestDispatcher("/backend/admGood?task=getGoods").forward(req, resp);
		}else {
			resp.sendRedirect("http://localhost:8080/ECProject/backend/error.jsp");
		} */
		getGoods(req, resp);
	}
	public void getType(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		resp.setContentType("text/json;charset=utf-8");
		PrintWriter out = resp.getWriter();
		String sql="select typeid,typename from t_goodstype where majorclassid is null";
		String params[]={};
		List<String> typeArray=new ArrayList<String>();
		String type=null;
		try {
			ResultSet rs=DaoFactory.getUserDaoInstances().doSelect(sql, params);
			while(rs.next()){
				type=rs.getInt(1)+"&"+rs.getString(2);
				typeArray.add(type);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		/*for (String string : typeArray) {
			System.out.println(string);
		}*/
		JSONArray jsonarray = JSONArray.fromObject(typeArray);
		out.print(jsonarray);
		out.close();
	}
	public void getSmType(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		resp.setContentType("text/json;charset=utf-8");
		PrintWriter out = resp.getWriter();
		String sql="select typeid,typename from t_goodstype where majorclassid=?";
		String majorclassid=req.getParameter("typeid");
		String params[]={majorclassid};
		List<String> typeArray=new ArrayList<String>();
		String type=null;
		try {
			ResultSet rs=DaoFactory.getUserDaoInstances().doSelect(sql, params);
			while(rs.next()){
				type=rs.getInt(1)+"&"+rs.getString(2);
				typeArray.add(type);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		JSONArray jsonarray = JSONArray.fromObject(typeArray);
		out.print(jsonarray);
		out.close();
	}
	public void delGood(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		String goodID=req.getParameter("goodID");
		String sql="delete from t_goods where goodid=?";
		String params[]={goodID};
		try {
			DaoFactory.getUserDaoInstances().doDelete(sql, params);
		} catch (Exception e) {
			e.printStackTrace();
		}
		
	}
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		doPost(req, resp);
	}

	@Override
	protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		String task=req.getParameter("task");
		if(task!=null){
			if("getGoods".equals(task)){
				getGoods(req, resp);
			}else if("addGood".equals(task)){
				addGood(req, resp);
			}else if("getType".equals(task)){
				getType(req, resp);
			}else if("getSmType".equals(task)){
				getSmType(req, resp);
			}else if("delGood".equals(task)){
				
			}
		}
	}

}
